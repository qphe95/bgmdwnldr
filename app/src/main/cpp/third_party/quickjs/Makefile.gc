# Makefile for QuickJS Handle-Based GC Testing

CC = gcc
CFLAGS = -Wall -Wextra -O2 -g -I.
LDFLAGS = 

# Source files
GC_SRC = quickjs_gc_rewrite.c
TEST_SRC = test_handle_gc.c

# Object files
GC_OBJ = $(GC_SRC:.c=.o)
TEST_OBJ = $(TEST_SRC:.c=.o)

# Executables
TEST_BIN = test_handle_gc

.PHONY: all clean test

all: $(TEST_BIN)

# Build the test harness
$(TEST_BIN): $(TEST_OBJ) $(GC_OBJ)
	$(CC) $(LDFLAGS) -o $@ $^

# Build object files
%.o: %.c quickjs_gc_rewrite.h
	$(CC) $(CFLAGS) -c -o $@ $<

# Run tests
test: $(TEST_BIN)
	./$(TEST_BIN)

# Run with valgrind for memory checking
valgrind: $(TEST_BIN)
	valgrind --leak-check=full --show-leak-kinds=all ./$(TEST_BIN)

# Clean build artifacts
clean:
	rm -f $(GC_OBJ) $(TEST_OBJ) $(TEST_BIN)

# Debug build
debug: CFLAGS = -Wall -Wextra -O0 -g -DDEBUG -I.
debug: clean $(TEST_BIN)

# Performance test with optimization
perf: CFLAGS = -Wall -O3 -DNDEBUG -I.
perf: clean $(TEST_BIN)
	./$(TEST_BIN)
