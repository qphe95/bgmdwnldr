# LLDB Commands to run AFTER attaching to process
#
# This script automates the watchpoint debugging

# Step 1: Set breakpoint at JS_AddIntrinsicBasicObjects
breakpoint set -n JS_AddIntrinsicBasicObjects

# Step 2: Continue until we hit it
continue

# Step 3: When breakpoint hits, log state
script print("=== At JS_AddIntrinsicBasicObjects ===")
script print("Use 'next' to step through until global_obj is created")
script print("Check logcat for shape address output")
script print("Then use: watchpoint set expression -w write -- <shape_addr>")

# Alternative: Set breakpoint at the end of JS_AddIntrinsicBasicObjects
# and then set watchpoint before continuing to init_browser_stubs
breakpoint set -n init_browser_stubs

continue

script print("=== At init_browser_stubs ===")
script print("Get the shape address from the debug log")
script print("Use: expression JSObject *p = JS_VALUE_GET_OBJ(ctx->global_obj); p->shape")
script print("Then: watchpoint set expression -w write -- <address_of_shape_field>")
